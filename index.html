<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ€§èƒ½å¸¦å®½è®¡ç®—å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }
        
        body {
            background-color: #121826;
            color: #e0e6ef;
            line-height: 1.6;
            padding: 10px;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 30px;
        }
        
        header {
            text-align: center;
            padding: 20px 10px;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 8px;
        }
        
        .subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            max-width: 90%;
            margin: 0 auto;
        }
        
        .card {
            background: #1e2430;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid #2a3140;
        }
        
        .card-title {
            font-size: 1.2rem;
            color: #e0e6ef;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a3140;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: nowrap;
            gap: 10px;
        }
        
        .card-title-text {
            display: flex;
            align-items: center;
            white-space: nowrap;
        }
        
        .card-title i {
            margin-right: 10px;
            color: #6a11cb;
        }
        
        /* ç®€åŒ–ç‰ˆæ¨¡å¼åˆ‡æ¢æŒ‰é’® - æ”¾åœ¨æ•°æ®è¾“å…¥æ ‡é¢˜å³ä¾§ */
        .mode-toggle-btn {
            min-width: 70px;
            height: 30px;
            border-radius: 6px;
            border: none;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            padding: 0 8px;
            gap: 4px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .mode-toggle-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .mode-toggle-btn:active {
            transform: translateY(0);
        }
        
        .mode-toggle-btn.small-better {
            background: rgba(231, 76, 60, 0.4); /* çº¢è‰²åŠ æ·± */
        }
        
        .mode-toggle-btn.large-better {
            background: rgba(46, 204, 113, 0.4); /* ç»¿è‰²åŠ æ·± */
        }
        
        .input-section textarea {
            width: 100%;
            min-height: 100px;
            max-height: 300px;
            padding: 15px;
            border: 2px solid #3a4255;
            border-radius: 10px;
            font-size: 1rem;
            resize: none;
            transition: all 0.3s;
            background-color: #2a3140;
            color: #e0e6ef;
            overflow-y: auto;
        }
        
        .input-section textarea:focus {
            outline: none;
            border-color: #6a11cb;
        }
        
        .input-hint {
            font-size: 0.85rem;
            color: #a0a6b0;
            margin-top: 8px;
            margin-bottom: 15px;
        }
        
        .btn-group-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #6a11cb, #2575fc);
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(106, 17, 203, 0.5);
        }
        
        .btn-secondary {
            background: #3a4255;
            color: #e0e6ef;
        }
        
        .btn-secondary:hover, .btn-secondary:active {
            background: #4a5265;
        }
        
        .btn-danger {
            background: #ff4757;
            color: white;
        }
        
        .btn-danger:hover, .btn-danger:active {
            background: #ff6b81;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(255, 71, 87, 0.3);
        }
        
        /* LACUåŒºé—´æ–¹å—å¸ƒå±€ */
        .lacu-container {
            margin-top: 5px;
        }
        
        .lacu-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .lacu-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
            border-radius: 12px;
            text-align: center;
            min-height: 100px;
        }
        
        .lacu-label {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .lacu-range {
            font-size: 1.1rem;
            line-height: 1.4;
            font-weight: 700;
        }
        
        .L-box { 
            background-color: rgba(231, 76, 60, 0.15); 
            border: 2px solid rgba(231, 76, 60, 0.4);
        }
        .A-box { 
            background-color: rgba(243, 156, 18, 0.15); 
            border: 2px solid rgba(243, 156, 18, 0.4);
        }
        .C-box { 
            background-color: rgba(46, 204, 113, 0.15); 
            border: 2px solid rgba(46, 204, 113, 0.4);
        }
        .U-box { 
            background-color: rgba(52, 152, 219, 0.15); 
            border: 2px solid rgba(52, 152, 219, 0.4);
        }
        
        .L-label { color: #e74c3c; }
        .A-label { color: #f39c12; }
        .C-label { color: #2ecc71; }
        .U-label { color: #3498db; }
        
        /* ç»Ÿè®¡æ‘˜è¦ */
        .stats-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 12px 0;
            border-top: 1px solid #2a3140;
            font-size: 0.95rem;
            color: #e0e6ef;
        }
        
        .chart-container {
            position: relative;
            height: 380px;
            width: 100%;
            margin-top: 10px;
        }
        
        .note {
            font-size: 0.85rem;
            color: #a0a6b0;
            margin-top: 20px;
            padding: 15px;
            background: #2a3140;
            border-radius: 10px;
            border-left: 4px solid #6a11cb;
        }
        
        /* ä¿®å¤å…¶ä»–å¡ç‰‡çš„æ ‡é¢˜å¸ƒå±€ */
        .results-section .card-title,
        .chart-section .card-title,
        .lacu-definition-section .card-title {
            display: block;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a3140;
        }
        
        .results-section .card-title-text,
        .chart-section .card-title-text,
        .lacu-definition-section .card-title-text {
            display: flex;
            align-items: center;
        }
        
        /* å½“å‰æ¨¡å¼æç¤ºæ ·å¼ - é¢œè‰²æ”¹ä¸ºç™½è‰² */
        .current-mode-hint {
            font-size: 0.9rem;
            color: #ffffff; /* æ”¹ä¸ºç™½è‰² */
            font-weight: 600;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3a4255;
        }
        
        /* é¡µè„šæ ·å¼ */
        .footer {
            text-align: center;
            color: #a0a6b0;
            padding: 20px 0;
            font-size: 0.85rem;
            margin-top: 20px;
            border-top: 1px solid #2a3140;
        }
        
        /* å“åº”å¼è®¾è®¡ - ä¿æŒæ¨ªå‘å¸ƒå±€ï¼Œåªè°ƒæ•´å­—ä½“å¤§å° */
        @media (max-width: 768px) {
            .lacu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .lacu-box {
                padding: 18px 8px;
                min-height: 90px;
            }
            
            .lacu-label {
                font-size: 1.6rem;
                margin-bottom: 8px;
            }
            
            .lacu-range {
                font-size: 1rem;
                font-weight: 700;
            }
            
            .chart-container {
                height: 320px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .mode-toggle-btn {
                min-width: 65px;
                height: 28px;
                font-size: 0.8rem;
                padding: 0 6px;
            }
            
            .footer {
                font-size: 0.8rem;
                padding: 15px 0;
            }
        }
        
        @media (max-width: 480px) {
            .btn-group-3 button {
                font-size: 0.9rem;
                padding: 12px 8px;
            }
            
            .btn-group-3 button span.long-text {
                display: none;
            }
            
            .btn-group-3 button span.short-text {
                display: inline;
            }
            
            .lacu-grid {
                gap: 8px;
            }
            
            .lacu-box {
                padding: 15px 5px;
                min-height: 85px;
            }
            
            .lacu-label {
                font-size: 1.5rem;
            }
            
            .lacu-range {
                font-size: 0.95rem;
                font-weight: 700;
            }
            
            .chart-container {
                height: 300px;
            }
            
            .card-title {
                font-size: 1rem;
                gap: 8px;
            }
            
            .mode-toggle-btn {
                min-width: 60px;
                height: 26px;
                font-size: 0.75rem;
                padding: 0 5px;
            }
        }
        
        @media (max-width: 360px) {
            .card-title {
                font-size: 0.95rem;
            }
            
            .mode-toggle-btn {
                min-width: 55px;
                font-size: 0.7rem;
            }
            
            .footer {
                font-size: 0.75rem;
                padding: 10px 0;
            }
        }
        
        @media (min-width: 481px) {
            .btn-group-3 button span.short-text {
                display: none;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #6a11cb;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #6a11cb;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ€§èƒ½å¸¦å®½è®¡ç®—å™¨</h1>
            <p class="subtitle">è¾“å…¥æ ·æœ¬æ•°æ®ï¼Œè‡ªåŠ¨è®¡ç®—å‡å€¼ã€æ ‡å‡†å·®ï¼Œç¡®å®šLã€Aã€Cã€Uå¸¦å®½åŒºé—´</p>
        </header>
        
        <main>
            <section class="card input-section">
                <h2 class="card-title">
                    <div class="card-title-text">
                        <span>ğŸ“Š</span> æ•°æ®è¾“å…¥
                    </div>
                    <!-- ç®€åŒ–ç‰ˆæ¨¡å¼åˆ‡æ¢æŒ‰é’®æ”¾åœ¨æ•°æ®è¾“å…¥æ ‡é¢˜å³ä¾§ -->
                    <button id="modeToggleBtn" class="mode-toggle-btn small-better" title="å½“å‰æ¨¡å¼ï¼šæ•°å€¼è¶Šå°è¶Šå¥½ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºè¶Šå¤§è¶Šå¥½">
                        <span class="mode-icon">â‡…</span>
                        <span class="mode-text">å°å¥½</span>
                    </button>
                </h2>
                <textarea id="dataInput" placeholder="è¯·è¾“å…¥æ ·æœ¬æ•°æ®ï¼Œç”¨é€—å·ã€ç©ºæ ¼æˆ–æ¢è¡Œåˆ†éš”ã€‚ä¾‹å¦‚ï¼š4.4, 3.75, 6.23, 4.65, 4.35, 6.84, 5.5, 4.81, 4.95, 5.18"></textarea>
                <p class="input-hint">è¯·è¾“å…¥è‡³å°‘3ä¸ªæ•°å€¼ï¼Œä»¥è®¡ç®—æœ‰æ•ˆçš„ç»Ÿè®¡ç»“æœã€‚</p>
                
                <div class="btn-group-3">
                    <button class="btn-primary" id="calculateBtn">
                        <span class="long-text">è®¡ç®—å¹¶ç»˜åˆ¶å›¾è¡¨</span>
                        <span class="short-text">è®¡ç®—</span>
                    </button>
                    <button class="btn-secondary" id="sampleDataBtn">
                        <span class="long-text">ä½¿ç”¨ç¤ºä¾‹æ•°æ®</span>
                        <span class="short-text">ç¤ºä¾‹</span>
                    </button>
                    <button class="btn-danger" id="clearDataBtn">
                        <span class="long-text">æ¸…é™¤å…¨éƒ¨æ•°æ®</span>
                        <span class="short-text">æ¸…é™¤</span>
                    </button>
                </div>
                
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨è®¡ç®—å¹¶ç»˜åˆ¶å›¾è¡¨...</p>
                </div>
            </section>
            
            <section class="card results-section" id="resultsCard" style="display: none;">
                <h2 class="card-title">
                    <div class="card-title-text">
                        <span>ğŸ“ˆ</span> è®¡ç®—ç»“æœ
                    </div>
                </h2>
                
                <!-- LACUåŒºé—´æ–¹å— -->
                <div class="lacu-container">
                    <div class="lacu-grid">
                        <div class="lacu-box L-box">
                            <div class="lacu-label L-label">L</div>
                            <div class="lacu-range" id="lRangeDisplay">(-âˆ, 0.00]</div>
                        </div>
                        <div class="lacu-box A-box">
                            <div class="lacu-label A-label">A</div>
                            <div class="lacu-range" id="aRangeDisplay">(0.00, 0.00]</div>
                        </div>
                        <div class="lacu-box C-box">
                            <div class="lacu-label C-label">C</div>
                            <div class="lacu-range" id="cRangeDisplay">(0.00, 0.00]</div>
                        </div>
                        <div class="lacu-box U-box">
                            <div class="lacu-label U-label">U</div>
                            <div class="lacu-range" id="uRangeDisplay">(0.00, +âˆ)</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç»Ÿè®¡æ‘˜è¦ -->
                <div class="stats-summary">
                    <div>å‡å€¼: <span id="meanValue">0.00</span></div>
                    <div>æ ‡å‡†å·®: <span id="stdValue">0.00</span></div>
                    <div>æœ‰æ•ˆæ•°æ®: <span id="validCount">0</span>/<span id="totalCount">0</span></div>
                </div>
            </section>
            
            <section class="card chart-section" id="chartCard" style="display: none;">
                <h2 class="card-title">
                    <div class="card-title-text">
                        <span>ğŸ“Š</span> æ€§èƒ½å¸¦å®½åˆ†å¸ƒ
                    </div>
                </h2>
                
                <div class="chart-container">
                    <canvas id="bandwidthChart"></canvas>
                </div>
                
                <div class="note">
                    <p><strong>è¯´æ˜:</strong></p>
                    <p id="chartDescription">æŸ±çŠ¶å›¾æŒ‰æ•°æ®å€¼ä»é«˜åˆ°ä½æ’åˆ—ï¼Œä¸åŒé¢œè‰²è¡¨ç¤ºä¸åŒçš„LACUåŒºé—´ã€‚</p>
                </div>
            </section>
            
            <section class="card lacu-definition-section">
                <h2 class="card-title">
                    <div class="card-title-text">
                        <span>â„¹ï¸</span> LACUåŒºé—´å®šä¹‰
                    </div>
                </h2>
                <div class="note" id="lacuDefinition">
                    <!-- è¿™é‡Œä¼šåŠ¨æ€æ›´æ–°å½“å‰æ¨¡å¼ -->
                    <p><strong>L (Leader):</strong> æ•°å€¼ â‰¤ å‡å€¼ - 1.25 Ã— æ ‡å‡†å·®</p>
                    <p><strong>A (Among the Leaders):</strong> å‡å€¼ - 1.25 Ã— æ ‡å‡†å·® < æ•°å€¼ â‰¤ å‡å€¼ - 0.5 Ã— æ ‡å‡†å·®</p>
                    <p><strong>C (Competitive):</strong> å‡å€¼ - 0.5 Ã— æ ‡å‡†å·® < æ•°å€¼ â‰¤ å‡å€¼ + 0.5 Ã— æ ‡å‡†å·®</p>
                    <p><strong>U (Uncompetitive):</strong> æ•°å€¼ > å‡å€¼ + 0.5 Ã— æ ‡å‡†å·®</p>
                    <p style="margin-top: 10px;"><em>æ³¨ï¼šæ ‡å‡†å·®ä½¿ç”¨æ— åä¼°è®¡å…¬å¼è®¡ç®—ï¼ˆé™¤ä»¥n-1ï¼‰</em></p>
                </div>
            </section>
        </main>
        
        <!-- æ–°å¢é¡µè„š -->
        <footer class="footer">
            æ€§èƒ½å¸¦å®½è®¡ç®—å™¨ Â© 2025 | æ¨ªå±æ˜¾ç¤ºæ•ˆæœæ›´ä½³
        </footer>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let bandwidthChart = null;
        let currentData = [];
        let mean = 0;
        let std = 0;
        let isMaxBetterMode = false; // false: è¶Šå°è¶Šå¥½, true: è¶Šå¤§è¶Šå¥½
        
        // DOMå…ƒç´ 
        const dataInput = document.getElementById('dataInput');
        const calculateBtn = document.getElementById('calculateBtn');
        const sampleDataBtn = document.getElementById('sampleDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const modeToggleBtn = document.getElementById('modeToggleBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsCard = document.getElementById('resultsCard');
        const chartCard = document.getElementById('chartCard');
        const chartDescription = document.getElementById('chartDescription');
        const lacuDefinition = document.getElementById('lacuDefinition');
        
        // ç»“æœå…ƒç´ 
        const meanValue = document.getElementById('meanValue');
        const stdValue = document.getElementById('stdValue');
        const lRangeDisplay = document.getElementById('lRangeDisplay');
        const aRangeDisplay = document.getElementById('aRangeDisplay');
        const cRangeDisplay = document.getElementById('cRangeDisplay');
        const uRangeDisplay = document.getElementById('uRangeDisplay');
        const totalCount = document.getElementById('totalCount');
        const validCount = document.getElementById('validCount');
        
        // ç¤ºä¾‹æ•°æ® - ä¿®æ”¹ä¸ºï¼š4.4,3.75,6.23,4.65,4.35,6.84,5.5,4.81,4.95,5.18
        const sampleData = [4.4, 3.75, 6.23, 4.65, 4.35, 6.84, 5.5, 4.81, 4.95, 5.18];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ç¤ºä¾‹æ•°æ®
            dataInput.value = sampleData.join(', ');
            
            // åˆå§‹åŒ–æ¨¡å¼æŒ‰é’®å’ŒLACUå®šä¹‰æ˜¾ç¤º
            updateModeButton(); // æ–°å¢ï¼šåˆå§‹åŒ–æ¨¡å¼æŒ‰é’®æ˜¾ç¤º
            updateLACUDefinition(); // æ–°å¢ï¼šåˆå§‹åŒ–LACUå®šä¹‰æ˜¾ç¤º
            
            // äº‹ä»¶ç›‘å¬
            calculateBtn.addEventListener('click', calculateAndPlot);
            sampleDataBtn.addEventListener('click', () => {
                dataInput.value = sampleData.join(', ');
                calculateAndPlot();
            });
            clearDataBtn.addEventListener('click', () => {
                dataInput.value = '';
            });
            
            // æ¨¡å¼åˆ‡æ¢ç›‘å¬
            modeToggleBtn.addEventListener('click', function() {
                isMaxBetterMode = !isMaxBetterMode;
                updateModeButton();
                updateLACUDefinition();
                
                // å¦‚æœæœ‰å½“å‰æ•°æ®ï¼Œé‡æ–°è®¡ç®—
                if (currentData.length > 0) {
                    calculateAndPlot();
                }
            });
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            dataInput.addEventListener('input', autoResizeTextarea);
            
            // åˆå§‹è®¡ç®—
            setTimeout(calculateAndPlot, 500);
        });
        
        // æ›´æ–°æ¨¡å¼æŒ‰é’®
        function updateModeButton() {
            const modeIcon = modeToggleBtn.querySelector('.mode-icon');
            const modeText = modeToggleBtn.querySelector('.mode-text');
            
            if (isMaxBetterMode) {
                // è¶Šå¤§è¶Šå¥½æ¨¡å¼
                modeIcon.textContent = 'â‡…';
                modeText.textContent = 'å¤§å¥½';
                modeToggleBtn.title = "å½“å‰æ¨¡å¼ï¼šæ•°å€¼è¶Šå¤§è¶Šå¥½ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºè¶Šå°è¶Šå¥½";
                modeToggleBtn.classList.remove('small-better');
                modeToggleBtn.classList.add('large-better');
                chartDescription.textContent = "æŸ±çŠ¶å›¾æŒ‰æ•°æ®å€¼ä»é«˜åˆ°ä½æ’åˆ—ï¼Œä¸åŒé¢œè‰²è¡¨ç¤ºä¸åŒçš„LACUåŒºé—´ã€‚";
            } else {
                // è¶Šå°è¶Šå¥½æ¨¡å¼
                modeIcon.textContent = 'â‡…';
                modeText.textContent = 'å°å¥½';
                modeToggleBtn.title = "å½“å‰æ¨¡å¼ï¼šæ•°å€¼è¶Šå°è¶Šå¥½ï¼Œç‚¹å‡»åˆ‡æ¢ä¸ºè¶Šå¤§è¶Šå¥½";
                modeToggleBtn.classList.remove('large-better');
                modeToggleBtn.classList.add('small-better');
                chartDescription.textContent = "æŸ±çŠ¶å›¾æŒ‰æ•°æ®å€¼ä»é«˜åˆ°ä½æ’åˆ—ï¼Œä¸åŒé¢œè‰²è¡¨ç¤ºä¸åŒçš„LACUåŒºé—´ã€‚";
            }
        }
        
        // æ›´æ–°LACUå®šä¹‰
        function updateLACUDefinition() {
            let modeHint = '';
            if (isMaxBetterMode) {
                modeHint = '<p class="current-mode-hint">å½“å‰æ¨¡å¼ï¼šæ•°å€¼è¶Šå¤§è¶Šå¥½</p>';
                lacuDefinition.innerHTML = modeHint + `
                    <p><strong>L (Leader):</strong> æ•°å€¼ â‰¥ å‡å€¼ + 1.25 Ã— æ ‡å‡†å·®</p>
                    <p><strong>A (Among the Leaders):</strong> å‡å€¼ + 0.5 Ã— æ ‡å‡†å·® â‰¤ æ•°å€¼ < å‡å€¼ + 1.25 Ã— æ ‡å‡†å·®</p>
                    <p><strong>C (Competitive):</strong> å‡å€¼ - 0.5 Ã— æ ‡å‡†å·® â‰¤ æ•°å€¼ < å‡å€¼ + 0.5 Ã— æ ‡å‡†å·®</p>
                    <p><strong>U (Uncompetitive):</strong> æ•°å€¼ < å‡å€¼ - 0.5 Ã— æ ‡å‡†å·®</p>
                    <p style="margin-top: 10px;"><em>æ³¨ï¼šæ ‡å‡†å·®ä½¿ç”¨æ— åä¼°è®¡å…¬å¼è®¡ç®—ï¼ˆé™¤ä»¥n-1ï¼‰</em></p>
                `;
            } else {
                modeHint = '<p class="current-mode-hint">å½“å‰æ¨¡å¼ï¼šæ•°å€¼è¶Šå°è¶Šå¥½</p>';
                lacuDefinition.innerHTML = modeHint + `
                    <p><strong>L (Leader):</strong> æ•°å€¼ â‰¤ å‡å€¼ - 1.25 Ã— æ ‡å‡†å·®</p>
                    <p><strong>A (Among the Leaders):</strong> å‡å€¼ - 1.25 Ã— æ ‡å‡†å·® < æ•°å€¼ â‰¤ å‡å€¼ - 0.5 Ã— æ ‡å‡†å·®</p>
                    <p><strong>C (Competitive):</strong> å‡å€¼ - 0.5 Ã— æ ‡å‡†å·® < æ•°å€¼ â‰¤ å‡å€¼ + 0.5 Ã— æ ‡å‡†å·®</p>
                    <p><strong>U (Uncompetitive):</strong> æ•°å€¼ > å‡å€¼ + 0.5 Ã— æ ‡å‡†å·®</p>
                    <p style="margin-top: 10px;"><em>æ³¨ï¼šæ ‡å‡†å·®ä½¿ç”¨æ— åä¼°è®¡å…¬å¼è®¡ç®—ï¼ˆé™¤ä»¥n-1ï¼‰</em></p>
                `;
            }
        }
        
        // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
        function autoResizeTextarea() {
            const textarea = dataInput;
            textarea.style.height = 'auto';
            const newHeight = Math.min(textarea.scrollHeight, 300);
            textarea.style.height = newHeight + 'px';
        }
        
        // è§£æè¾“å…¥æ•°æ®
        function parseInputData(input) {
            const cleanedInput = input.replace(/ï¼Œ/g, ',').replace(/\s+/g, ',');
            const parts = cleanedInput.split(',');
            
            const numbers = parts
                .map(part => parseFloat(part.trim()))
                .filter(num => !isNaN(num) && isFinite(num));
                
            return numbers;
        }
        
        // è®¡ç®—å‡å€¼
        function calculateMean(data) {
            const sum = data.reduce((acc, val) => acc + val, 0);
            return sum / data.length;
        }
        
        // è®¡ç®—æ ·æœ¬æ ‡å‡†å·®
        function calculateStd(data, mean) {
            if (data.length < 2) return 0;
            
            const squaredDiffs = data.map(val => Math.pow(val - mean, 2));
            const sumSquaredDiffs = squaredDiffs.reduce((acc, val) => acc + val, 0);
            return Math.sqrt(sumSquaredDiffs / (data.length - 1));
        }
        
        // ç¡®å®šLACUåŒºé—´
        function determineLACU(value, mean, std) {
            if (isMaxBetterMode) {
                // è¶Šå¤§è¶Šå¥½æ¨¡å¼
                const uUpper = mean - 0.5 * std;      // UåŒºé—´çš„ä¸Šç•Œï¼ŒCåŒºé—´çš„ä¸‹ç•Œ
                const cUpper = mean + 0.5 * std;      // CåŒºé—´çš„ä¸Šç•Œï¼ŒAåŒºé—´çš„ä¸‹ç•Œ
                const aUpper = mean + 1.25 * std;     // AåŒºé—´çš„ä¸Šç•Œï¼ŒLåŒºé—´çš„ä¸‹ç•Œ
                
                if (value >= aUpper) return 'L';
                if (value >= cUpper && value < aUpper) return 'A';
                if (value >= uUpper && value < cUpper) return 'C';
                return 'U'; // value < uUpper
            } else {
                // è¶Šå°è¶Šå¥½æ¨¡å¼ï¼ˆåŸæ¨¡å¼ï¼‰
                const lUpper = mean - 1.25 * std;     // LåŒºé—´çš„ä¸Šç•Œï¼ŒAåŒºé—´çš„ä¸‹ç•Œ
                const aUpper = mean - 0.5 * std;      // AåŒºé—´çš„ä¸Šç•Œï¼ŒCåŒºé—´çš„ä¸‹ç•Œ
                const cUpper = mean + 0.5 * std;      // CåŒºé—´çš„ä¸Šç•Œï¼ŒUåŒºé—´çš„ä¸‹ç•Œ
                
                if (value <= lUpper) return 'L';
                if (value > lUpper && value <= aUpper) return 'A';
                if (value > aUpper && value <= cUpper) return 'C';
                return 'U'; // value > cUpper
            }
        }
        
        // è·å–åŒºé—´é¢œè‰²
        function getLACUColor(lacu) {
            switch(lacu) {
                case 'L': return '#e74c3c';
                case 'A': return '#f39c12';
                case 'C': return '#2ecc71';
                case 'U': return '#3498db';
                default: return '#95a5a6';
            }
        }
        
        // è®¡ç®—LACUè¾¹ç•Œå€¼
        function calculateLACUBoundaries(mean, std) {
            if (isMaxBetterMode) {
                // è¶Šå¤§è¶Šå¥½æ¨¡å¼
                return {
                    lLower: mean + 1.25 * std,    // LåŒºé—´çš„ä¸‹ç•Œ
                    aLower: mean + 0.5 * std,     // AåŒºé—´çš„ä¸‹ç•Œ
                    aUpper: mean + 1.25 * std,    // AåŒºé—´çš„ä¸Šç•Œ
                    cLower: mean - 0.5 * std,     // CåŒºé—´çš„ä¸‹ç•Œ
                    cUpper: mean + 0.5 * std,     // CåŒºé—´çš„ä¸Šç•Œ
                    uUpper: mean - 0.5 * std      // UåŒºé—´çš„ä¸Šç•Œ
                };
            } else {
                // è¶Šå°è¶Šå¥½æ¨¡å¼
                return {
                    lUpper: mean - 1.25 * std,    // LåŒºé—´çš„ä¸Šç•Œ
                    aLower: mean - 1.25 * std,    // AåŒºé—´çš„ä¸‹ç•Œ
                    aUpper: mean - 0.5 * std,     // AåŒºé—´çš„ä¸Šç•Œ
                    cLower: mean - 0.5 * std,     // CåŒºé—´çš„ä¸‹ç•Œ
                    cUpper: mean + 0.5 * std,     // CåŒºé—´çš„ä¸Šç•Œ
                    uLower: mean + 0.5 * std      // UåŒºé—´çš„ä¸‹ç•Œ
                };
            }
        }
        
        // æ›´æ–°LACUåŒºé—´æ˜¾ç¤º
        function updateLACUDisplay(boundaries) {
            if (isMaxBetterMode) {
                // è¶Šå¤§è¶Šå¥½æ¨¡å¼æ˜¾ç¤º
                lRangeDisplay.textContent = `[${boundaries.lLower.toFixed(2)}, +âˆ)`;
                aRangeDisplay.textContent = `[${boundaries.aLower.toFixed(2)}, ${boundaries.aUpper.toFixed(2)})`;
                cRangeDisplay.textContent = `[${boundaries.cLower.toFixed(2)}, ${boundaries.cUpper.toFixed(2)})`;
                uRangeDisplay.textContent = `(-âˆ, ${boundaries.uUpper.toFixed(2)})`;
            } else {
                // è¶Šå°è¶Šå¥½æ¨¡å¼æ˜¾ç¤º
                lRangeDisplay.textContent = `(-âˆ, ${boundaries.lUpper.toFixed(2)}]`;
                aRangeDisplay.textContent = `(${boundaries.aLower.toFixed(2)}, ${boundaries.aUpper.toFixed(2)}]`;
                cRangeDisplay.textContent = `(${boundaries.cLower.toFixed(2)}, ${boundaries.cUpper.toFixed(2)}]`;
                uRangeDisplay.textContent = `(${boundaries.uLower.toFixed(2)}, +âˆ)`;
            }
        }
        
        // è·å–å›¾è¡¨ä¸­éœ€è¦ç»˜åˆ¶çš„LACçº¿
        function getChartLines(boundaries) {
            if (isMaxBetterMode) {
                // è¶Šå¤§è¶Šå¥½æ¨¡å¼ï¼šç»˜åˆ¶CåŒºé—´çš„ä¸‹ç•Œã€AåŒºé—´çš„ä¸‹ç•Œã€LåŒºé—´çš„ä¸‹ç•Œ
                // è¿™äº›çº¿å¯¹åº”å„ä¸ªåŒºé—´çš„ä¸‹ç•Œï¼Œç”¨äºåˆ¤æ–­æ•°æ®ç‚¹å±äºå“ªä¸ªåŒºé—´
                return [
                    { value: boundaries.cLower, color: '#2ecc71', label: 'C', lightColor: 'rgba(46, 204, 113, 0.2)' },
                    { value: boundaries.aLower, color: '#f39c12', label: 'A', lightColor: 'rgba(243, 156, 18, 0.2)' },
                    { value: boundaries.lLower, color: '#e74c3c', label: 'L', lightColor: 'rgba(231, 76, 60, 0.2)' }
                ].sort((a, b) => a.value - b.value); // ä»ä½åˆ°é«˜æ’åº
            } else {
                // è¶Šå°è¶Šå¥½æ¨¡å¼ï¼šç»˜åˆ¶LåŒºé—´çš„ä¸Šç•Œã€AåŒºé—´çš„ä¸Šç•Œã€CåŒºé—´çš„ä¸Šç•Œ
                // è¿™äº›çº¿å¯¹åº”å„ä¸ªåŒºé—´çš„ä¸Šç•Œï¼Œç”¨äºåˆ¤æ–­æ•°æ®ç‚¹å±äºå“ªä¸ªåŒºé—´
                return [
                    { value: boundaries.lUpper, color: '#e74c3c', label: 'L', lightColor: 'rgba(231, 76, 60, 0.2)' },
                    { value: boundaries.aUpper, color: '#f39c12', label: 'A', lightColor: 'rgba(243, 156, 18, 0.2)' },
                    { value: boundaries.cUpper, color: '#2ecc71', label: 'C', lightColor: 'rgba(46, 204, 113, 0.2)' }
                ].sort((a, b) => a.value - b.value); // ä»ä½åˆ°é«˜æ’åº
            }
        }
        
        // æ ¼å¼åŒ–æ•°å€¼ï¼Œå¦‚æœå°æ•°éƒ¨åˆ†ä¸º0åˆ™ä¸æ˜¾ç¤ºå°æ•°éƒ¨åˆ†
        function formatNumber(value) {
            // æ£€æŸ¥æ˜¯å¦ä¸ºæ•´æ•°æˆ–å°æ•°éƒ¨åˆ†ä¸º0
            if (Number.isInteger(value)) {
                return value.toString();
            }
            
            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶æ£€æŸ¥å°æ•°éƒ¨åˆ†æ˜¯å¦éƒ½æ˜¯0
            const str = value.toString();
            const parts = str.split('.');
            
            if (parts.length === 2) {
                // æ£€æŸ¥å°æ•°éƒ¨åˆ†æ˜¯å¦å…¨æ˜¯0
                if (/^0+$/.test(parts[1])) {
                    return parts[0]; // è¿”å›æ•´æ•°éƒ¨åˆ†
                }
                // å»æ‰æœ«å°¾çš„0
                return value.toFixed(2).replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
            }
            
            return str;
        }
        
        // è®¡ç®—å¹¶ç»˜åˆ¶å›¾è¡¨
        function calculateAndPlot() {
            // è§£æè¾“å…¥æ•°æ®
            const inputData = parseInputData(dataInput.value);
            
            // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
            if (inputData.length < 3) {
                alert('è¯·è¾“å…¥è‡³å°‘3ä¸ªæœ‰æ•ˆæ•°å€¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            loadingIndicator.style.display = 'block';
            resultsCard.style.display = 'none';
            chartCard.style.display = 'none';
            
            // ä½¿ç”¨setTimeoutè®©UIæœ‰æœºä¼šæ›´æ–°
            setTimeout(() => {
                try {
                    // ä¿å­˜å½“å‰æ•°æ®
                    currentData = [...inputData];
                    
                    // è®¡ç®—ç»Ÿè®¡å€¼
                    mean = calculateMean(currentData);
                    std = calculateStd(currentData, mean);
                    
                    // è®¡ç®—LACUè¾¹ç•Œ
                    const boundaries = calculateLACUBoundaries(mean, std);
                    
                    // æ›´æ–°è®¡ç®—ç»“æœ
                    meanValue.textContent = formatNumber(mean);
                    stdValue.textContent = formatNumber(std);
                    totalCount.textContent = dataInput.value.split(',').length;
                    validCount.textContent = currentData.length;
                    
                    // æ›´æ–°LACUåŒºé—´èŒƒå›´æ˜¾ç¤º
                    updateLACUDisplay(boundaries);
                    
                    // ç¡®å®šæ¯ä¸ªæ•°æ®ç‚¹çš„LACUåŒºé—´
                    const dataWithLACU = currentData.map(value => {
                        const lacu = determineLACU(value, mean, std);
                        return {
                            value,
                            lacu,
                            color: getLACUColor(lacu)
                        };
                    });
                    
                    // ä»é«˜åˆ°ä½æ’åºæ•°æ®
                    dataWithLACU.sort((a, b) => b.value - a.value);
                    
                    // å‡†å¤‡å›¾è¡¨æ•°æ®
                    const labels = dataWithLACU.map((_, index) => `æ•°æ®${index + 1}`);
                    const values = dataWithLACU.map(item => item.value);
                    const colors = dataWithLACU.map(item => item.color);
                    
                    // è·å–å›¾è¡¨éœ€è¦ç»˜åˆ¶çš„çº¿æ¡
                    const chartLines = getChartLines(boundaries);
                    
                    // ç»˜åˆ¶å›¾è¡¨
                    drawChart(labels, values, colors, chartLines);
                    
                    // éšè—åŠ è½½æŒ‡ç¤ºå™¨ï¼Œæ˜¾ç¤ºç»“æœ
                    loadingIndicator.style.display = 'none';
                    resultsCard.style.display = 'block';
                    chartCard.style.display = 'block';
                    
                } catch (error) {
                    console.error('è®¡ç®—æˆ–ç»˜å›¾é”™è¯¯:', error);
                    alert('è®¡ç®—è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥æ•°æ®æ ¼å¼');
                    loadingIndicator.style.display = 'none';
                }
            }, 100);
        }
        
        // ç»˜åˆ¶å›¾è¡¨
        function drawChart(labels, values, colors, chartLines) {
            const ctx = document.getElementById('bandwidthChart').getContext('2d');
            
            // å¦‚æœå­˜åœ¨ç°æœ‰å›¾è¡¨ï¼Œé”€æ¯å®ƒ
            if (bandwidthChart) {
                bandwidthChart.destroy();
            }
            
            // è®¡ç®—æ•°æ®èŒƒå›´
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            
            // è·å–æ‰€æœ‰è¾¹ç•Œå€¼
            const boundaryValues = chartLines.map(line => line.value);
            const allValues = [...values, ...boundaryValues];
            const absoluteMin = Math.min(...allValues);
            const absoluteMax = Math.max(...allValues);
            
            // è®¡ç®—æ•°æ®èŒƒå›´
            const dataRange = absoluteMax - absoluteMin;
            
            // æ ¹æ®æ•°æ®èŒƒå›´ç¡®å®špaddingæ¯”ä¾‹
            let paddingRatio;
            if (dataRange < 2) {
                paddingRatio = 0.1;
            } else if (dataRange < 5) {
                paddingRatio = 0.05;
            } else {
                paddingRatio = 0.02;
            }
            
            // è®¡ç®—Yè½´èŒƒå›´
            const chartMin = Math.max(0, Math.floor(absoluteMin - (dataRange * paddingRatio)));
            const chartMax = Math.ceil(absoluteMax + (dataRange * paddingRatio));
            const finalMin = chartMin;
            let finalMax = chartMax;
            
            // ç¡®ä¿Yè½´èŒƒå›´è¶³å¤Ÿæ˜¾ç¤ºæ‰€æœ‰æ•°æ®å’Œè¾¹ç•Œçº¿
            if (finalMax - finalMin < 2) {
                finalMax = finalMin + 2;
            }
            
            // è®¡ç®—åˆé€‚çš„æ­¥é•¿
            const range = finalMax - finalMin;
            const stepSize = calculateStepSize(range);
            
            // åˆ›å»ºæ–°å›¾è¡¨
            bandwidthChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            data: values,
                            backgroundColor: colors,
                            borderColor: colors.map(color => {
                                const r = parseInt(color.slice(1, 3), 16);
                                const g = parseInt(color.slice(3, 5), 16);
                                const b = parseInt(color.slice(5, 7), 16);
                                return `rgb(${Math.max(0, r-30)}, ${Math.max(0, g-30)}, ${Math.max(0, b-30)})`;
                            }),
                            borderWidth: 1,
                            yAxisID: 'y',
                            barPercentage: 0.7,
                            categoryPercentage: 0.8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 36, 48, 0.9)',
                            titleColor: '#e0e6ef',
                            bodyColor: '#e0e6ef',
                            borderColor: '#3a4255',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const lacu = determineLACU(value, mean, std);
                                    return `${formatNumber(value)} (${lacu}åŒºé—´)`;
                                },
                                title: function(context) {
                                    return `æ•°æ®${context[0].dataIndex + 1}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false,
                                color: '#2a3140'
                            },
                            ticks: {
                                maxRotation: 45,
                                font: {
                                    size: 10
                                },
                                color: '#a0a6b0'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: false
                            },
                            grid: {
                                drawBorder: false,
                                color: '#2a3140'
                            },
                            beginAtZero: false,
                            min: finalMin,
                            max: finalMax,
                            ticks: {
                                stepSize: stepSize,
                                callback: function(value, index, values) {
                                    if (Number.isInteger(value)) {
                                        if (index === values.length - 1) {
                                            return '';
                                        }
                                        return value;
                                    }
                                    return '';
                                },
                                font: {
                                    size: 11
                                },
                                color: '#a0a6b0',
                                maxTicksLimit: 8
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: window.innerWidth < 768 ? 60 : 80,
                            bottom: 10
                        }
                    }
                },
                plugins: [{
                    id: 'lacLines',
                    afterDraw: function(chart) {
                        const ctx = chart.ctx;
                        const yAxis = chart.scales.y;
                        const xAxis = chart.scales.x;
                        const chartArea = chart.chartArea;
                        const isMobile = window.innerWidth < 768;
                        
                        // ç»˜åˆ¶çº¿æ¡
                        chartLines.forEach(line => {
                            const yPosition = yAxis.getPixelForValue(line.value);
                            
                            if (yPosition < chartArea.top || yPosition > chartArea.bottom) {
                                return;
                            }
                            
                            // ç»˜åˆ¶æ¨ªçº¿
                            ctx.save();
                            ctx.beginPath();
                            ctx.moveTo(xAxis.left, yPosition);
                            ctx.lineTo(xAxis.right, yPosition);
                            ctx.lineWidth = 2;
                            ctx.strokeStyle = line.color;
                            ctx.setLineDash([5, 3]);
                            ctx.stroke();
                            ctx.restore();
                            
                            // åœ¨çº¿çš„æœ€å³ä¾§æ·»åŠ æ ‡ç­¾
                            ctx.save();
                            
                            const labelText = `${line.label}: ${formatNumber(line.value)}`;
                            const fontSize = isMobile ? 10 : 12;
                            ctx.font = `bold ${fontSize}px Arial`;
                            const textWidth = ctx.measureText(labelText).width;
                            
                            const rectX = chartArea.right + (isMobile ? 3 : 5);
                            const rectY = yPosition - (isMobile ? 10 : 12);
                            const rectWidth = textWidth + (isMobile ? 8 : 10);
                            const rectHeight = isMobile ? 20 : 24;
                            const borderRadius = 6;
                            
                            if (rectY + rectHeight > chartArea.bottom) {
                                ctx.restore();
                                return;
                            }
                            
                            // ç»˜åˆ¶åœ†è§’çŸ©å½¢
                            ctx.beginPath();
                            ctx.moveTo(rectX + borderRadius, rectY);
                            ctx.lineTo(rectX + rectWidth - borderRadius, rectY);
                            ctx.quadraticCurveTo(rectX + rectWidth, rectY, rectX + rectWidth, rectY + borderRadius);
                            ctx.lineTo(rectX + rectWidth, rectY + rectHeight - borderRadius);
                            ctx.quadraticCurveTo(rectX + rectWidth, rectY + rectHeight, rectX + rectWidth - borderRadius, rectY + rectHeight);
                            ctx.lineTo(rectX + borderRadius, rectY + rectHeight);
                            ctx.quadraticCurveTo(rectX, rectY + rectHeight, rectX, rectY + rectHeight - borderRadius);
                            ctx.lineTo(rectX, rectY + borderRadius);
                            ctx.quadraticCurveTo(rectX, rectY, rectX + borderRadius, rectY);
                            ctx.closePath();
                            
                            ctx.fillStyle = line.lightColor;
                            ctx.fill();
                            
                            ctx.strokeStyle = line.color;
                            ctx.lineWidth = 1;
                            ctx.stroke();
                            
                            ctx.fillStyle = line.color;
                            ctx.textAlign = 'left';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(
                                labelText, 
                                rectX + (isMobile ? 4 : 5), 
                                rectY + rectHeight/2
                            );
                            
                            ctx.restore();
                        });
                    }
                }, {
                    id: 'dataLabels',
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        
                        ctx.save();
                        ctx.fillStyle = '#e0e6ef';
                        
                        // æ ¹æ®å±å¹•å®½åº¦å’Œè®¾å¤‡ç±»å‹åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
                        const isMobile = window.innerWidth < 768;
                        
                        // è®¡ç®—å¹³å‡æŸ±å®½ï¼Œç”¨äºè°ƒæ•´å­—ä½“å¤§å°
                        let totalBarWidth = 0;
                        let barCount = 0;
                        meta.data.forEach((bar) => {
                            if (bar.width > 0) {
                                totalBarWidth += bar.width;
                                barCount++;
                            }
                        });
                        const avgBarWidth = barCount > 0 ? totalBarWidth / barCount : 0;
                        
                        // åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å° - æ‰‹æœºç«¯ä½¿ç”¨æ›´å°çš„å­—ä½“
                        let fontSize;
                        if (isMobile) {
                            // æ‰‹æœºç«¯æ ¹æ®æ•°æ®é‡è°ƒæ•´å­—ä½“å¤§å°
                            if (values.length > 15) {
                                fontSize = 7; // æ•°æ®å¾ˆå¤šæ—¶
                            } else if (values.length > 10) {
                                fontSize = 8; // æ•°æ®è¾ƒå¤šæ—¶
                            } else if (avgBarWidth < 25) {
                                fontSize = 8; // æŸ±å¾ˆçª„æ—¶
                            } else {
                                fontSize = 9; // æ­£å¸¸æƒ…å†µ
                            }
                        } else {
                            fontSize = 11; // æ¡Œé¢ç«¯
                        }
                        
                        ctx.font = `bold ${fontSize}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'bottom';
                        
                        // è®°å½•å·²ç»ç»˜åˆ¶æ ‡ç­¾çš„ä½ç½®ï¼Œé˜²æ­¢é‡å 
                        const drawnLabels = [];
                        const minSpacing = fontSize * 1.2; // æœ€å°é—´è·ä¸ºå­—ä½“é«˜åº¦çš„1.2å€
                        
                        meta.data.forEach((bar, index) => {
                            const value = values[index];
                            if (bar.height > 10) { // é™ä½é«˜åº¦è¦æ±‚ï¼Œç¡®ä¿æ›´å¤šæ ‡ç­¾æ˜¾ç¤º
                                // ä½¿ç”¨æ ¼å¼åŒ–å‡½æ•°æ ¼å¼åŒ–æ•°å€¼
                                const formattedValue = formatNumber(value);
                                
                                // è®¡ç®—æ ‡ç­¾ä½ç½®
                                const labelX = bar.x;
                                const labelY = bar.y - 3;
                                
                                // æ£€æŸ¥æ˜¯å¦ä¸å·²ç»˜åˆ¶çš„æ ‡ç­¾é‡å 
                                let canDraw = true;
                                for (const drawn of drawnLabels) {
                                    const distance = Math.abs(drawn.x - labelX);
                                    if (distance < minSpacing && Math.abs(drawn.y - labelY) < minSpacing) {
                                        canDraw = false;
                                        break;
                                    }
                                }
                                
                                if (canDraw) {
                                    // ç»˜åˆ¶æ ‡ç­¾èƒŒæ™¯ï¼ˆå¯é€‰ï¼Œæé«˜å¯è¯»æ€§ï¼‰
                                    if (isMobile && fontSize < 9) {
                                        ctx.save();
                                        ctx.fillStyle = 'rgba(30, 36, 48, 0.7)';
                                        const textWidth = ctx.measureText(formattedValue).width;
                                        const padding = 2;
                                        ctx.fillRect(
                                            labelX - textWidth/2 - padding,
                                            labelY - fontSize - 1,
                                            textWidth + padding * 2,
                                            fontSize + 2
                                        );
                                        ctx.restore();
                                        
                                        // æ¢å¤æ–‡æœ¬é¢œè‰²
                                        ctx.fillStyle = '#e0e6ef';
                                    }
                                    
                                    ctx.fillText(
                                        formattedValue,
                                        labelX,
                                        labelY
                                    );
                                    
                                    // è®°å½•å·²ç»˜åˆ¶æ ‡ç­¾çš„ä½ç½®
                                    drawnLabels.push({ x: labelX, y: labelY });
                                }
                            }
                        });
                        
                        ctx.restore();
                    }
                }]
            });
        }
        
        // è®¡ç®—Yè½´æ­¥é•¿çš„è¾…åŠ©å‡½æ•°
        function calculateStepSize(range) {
            if (range <= 2) return 0.5;
            if (range <= 5) return 1;
            if (range <= 10) return 1;
            if (range <= 20) return 2;
            if (range <= 50) return 5;
            return Math.ceil(range / 10);
        }
        
        // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œé‡æ–°ç»˜åˆ¶å›¾è¡¨
        window.addEventListener('resize', function() {
            if (bandwidthChart && currentData.length > 0) {
                const dataWithLACU = currentData.map(value => {
                    const lacu = determineLACU(value, mean, std);
                    return {
                        value,
                        lacu,
                        color: getLACUColor(lacu)
                    };
                });
                
                dataWithLACU.sort((a, b) => b.value - a.value);
                
                const labels = dataWithLACU.map((_, index) => `æ•°æ®${index + 1}`);
                const values = dataWithLACU.map(item => item.value);
                const colors = dataWithLACU.map(item => item.color);
                const boundaries = calculateLACUBoundaries(mean, std);
                const chartLines = getChartLines(boundaries);
                
                drawChart(labels, values, colors, chartLines);
            }
        });
    </script>
</body>
</html>